# TRAFIQO — СЕССИЯ 27.02.2026 v4
## Полное состояние проекта и план работ

---

## СТЕК И ИНФРАСТРУКТУРА

- **Стек:** Vanilla JS + Supabase + Vercel + Telegram WebApp
- **URL:** https://mlm-community.vercel.app
- **Supabase:** проект tydavmiamwdrfjbcgwny (mlm_com, Singapore)
- **БД:** 54 таблицы, все с RLS (138 политик)
- **Ветка:** main, синхронизирована с origin
- **Vercel:** задеплоен, auto-deploy из main

### Лимиты файлов (MASTER_RULES.md):
- HTML: < 500 строк
- JS: < 500 строк
- CSS: < 800 строк
- Функции: < 50 строк
- Запреты: нет React/Vue/jQuery, нет console.log, нет var, нет inline styles, нет emoji (SVG only)

---

## ЧТО СДЕЛАНО ЗА ВСЕ СЕССИИ

### P0 — КРИТИЧЕСКИЕ БАГИ (ЗАКРЫТ)

| Задача | Коммит |
|--------|--------|
| Auth race condition при reload | 52430b3 |
| SIGNED_OUT guard | 3bb88d2 |
| streak_days 400 ошибка | 7ca3d19 |
| Хардкод уровней в 4 файлах | 43b8e01, b91d686, b510b3c, b715b9a, c3207ac |
| complete-task формула XP + level/stars | 2752f59 |

### P1 — ГЕЙМИФИКАЦИЯ + ДНК (ЗАКРЫТ)

| Задача | Коммит |
|--------|--------|
| dna-reveal.js выделен из dna-card.js | 0f70a66 |
| dna-result.html — 3 таба | 5a04a20 |
| dna-card.js — логика табов | 5eb1c74 |
| dna.css — стили табов | fbf2916 |
| Экран "Моё ДНК" (6 коммитов) | e30a8d2 → cb2db0c |
| tasks.js — анимации XP/level_up/stars_up | 995b9b8 |
| Cron update-streaks (ежедневно 3:00 UTC) | SQL |
| Звёзды в профиле | b91d686 |

### P2 — ЭКРАНЫ + MAP (ЗАКРЫТ)

| Задача | Коммит |
|--------|--------|
| PROJECT_MAP.md обновлён (174 файла) | 4457c3b |
| Лидерборд: html + css + js + router + more.js | 0f9faa8 → 28bf287 |
| Рефералы: html + css + js + router + more.js | 1a10827 → f98d867 |
| SESSION_27_02_2026_v3.md | 7e8ef91 |

### ПОЛИРОВКА (ЗАКРЫТА — эта сессия)

| Задача | Коммит |
|--------|--------|
| var → const/let в leaderboard.js (36 шт.) | bfa7132 |
| escHtml вынесена в utils/format.js глобально | 9904e79 |
| XSS-фикс: comments.js | 13b92b1 |
| XSS-фикс: chat.js (+ safeFileUrl) | 7944cee |
| XSS-фикс: referrals.js (+ удалён дубль refEsc) | b88a713 |
| renderStars → renderExpertStars в experts.js | e955983 |
| Экран подписки: html + css + js + router + more | 9046919 → c643c3e |
| 3 Cron задачи настроены | Supabase SQL |
| Дубль update-streaks (jobid=4) удалён | Supabase SQL |

---

## CRON ЗАДАЧИ (4 активных)

| jobid | Задача | Расписание | Описание |
|-------|--------|-----------|----------|
| 7 | update-streaks-daily | 0 3 * * * | Обновляет стрики ежедневно 03:00 UTC |
| 8 | expire-subscriptions | 0 4 * * * | Отключает просроченные подписки 04:00 UTC |
| 9 | process-referral-monthly | 0 5 1 * * | Реферальные выплаты 1-е число 05:00 UTC |
| 10 | draw-contest | 0 20 * * 0 | Розыгрыш конкурсов воскресенье 20:00 UTC |

---

## ЭКРАНЫ: 52 реализовано

Все подключены в router.js (TEMPLATES + SCREEN_INITS) и index.html (CSS + JS).

Последние добавленные:
- scrLeaderboard — топ недели/месяца/всё время
- scrReferrals — ссылка, воронка, список рефералов, шеринг
- scrSubscription — выбор тарифа, покупка через EF

Точки входа: все три доступны из меню "Ещё" (more.js).
scrSubscription также доступен из profile-settings.

---

## EDGE FUNCTIONS (15 задеплоены)

| EF | Вызов | Статус |
|----|-------|--------|
| complete-task | tasks.js, admin | Активна |
| auth-telegram | api/auth.js | Активна |
| auth-email | api/auth.js | Активна |
| purchase-product | shop.js | Активна |
| purchase-subscription | subscription.js | Активна (подключена в этой сессии) |
| process-deal-payment | deals.js | Активна |
| accept-deal | deals.js | Активна |
| request-withdrawal | wallet.js | Активна |
| register-push-sub | push.js | Активна |
| send-push | Триггеры | Серверная |
| update-streaks | Cron | Серверная |
| expire-subscriptions | Cron | Серверная |
| process-referral-monthly | Cron | Серверная |
| draw-contest | Cron | Серверная |
| telegram-webhook | Telegram | Серверная |

---

## СОСТОЯНИЕ КЛЮЧЕВЫХ ФАЙЛОВ

| Файл | Строк | Лимит | Запас |
|------|-------|-------|-------|
| js/auth-core.js | 467 | 500 | 33 ⚠️ |
| js/feed-data.js | 420 | 500 | 80 |
| js/admin-core.js | 410 | 500 | 90 |
| js/screens/match.js | 402 | 500 | 98 |
| js/dna-card.js | 387 | 500 | 113 |
| js/admin-pages4.js | 360 | 500 | 140 |
| js/screens/tasks.js | 313 | 500 | 187 |
| js/router.js | 297 | 500 | 203 |
| js/screens/profile.js | 289 | 500 | 211 |
| index.html | 287 | 500 | 213 |
| js/screens/referrals.js | 260 | 500 | 240 |
| css/subscription.css | 224 | 800 | 576 |
| js/screens/leaderboard.js | 213 | 500 | 287 |
| js/screens/subscription.js | 176 | 500 | 324 |
| js/screens/more.js | 114 | 500 | 386 |
| js/utils/format.js | 31 | 500 | 469 |
| css/landing.css | 754 | 800 | 46 ⚠️ |
| css/dna-card.css | 684 | 800 | 116 |
| css/dna.css | 621 | 800 | 179 |
| css/referrals.css | 314 | 800 | 486 |
| css/leaderboard.css | 275 | 800 | 525 |

---

## АУДИТ БЕЗОПАСНОСТИ — РЕЗУЛЬТАТ

| Проблема | Статус |
|----------|--------|
| console.log в коде | 0 найдено ✅ |
| var в коде | 0 найдено ✅ (было 36 в leaderboard.js) |
| TODO/FIXME/HACK | 0 найдено ✅ |
| XSS через innerHTML | Закрыто ✅ (comments, chat, forum, referrals) |
| escHtml глобально | Доступна ✅ (window.escHtml из format.js) |
| Дубли функций (runtime) | Закрыто ✅ (renderStars → renderExpertStars) |
| Дубли функций (admin vs app) | Не конфликтуют (разные HTML) |
| RLS на всех таблицах | 54/54 ✅ (138 политик) |
| Cron задачи | 4/4 активны ✅ |

---

## GAMIFICATION API

```javascript
window.Gamification = {
  XP_TABLE,            // 26 уровней по ТЗ v5.1
  STREAK_MULTIPLIERS,  // 9 порогов по ТЗ v5.1
  getUserLevel(xpTotal),      // → { level, stars, label, mult }
  getLevelProgress(xpTotal),  // → { percent, current, needed }
  getMultiplier(level),       // → 1.0 / 1.3 / 1.6 / 2.0 / 2.5
  getStreakMultiplier(days),  // → 1.05 → 2.5
  calculateEarnedXP(base, level, streak),
}

// Анимации
window.showXpToast(xp, label)       // "+1.4K XP"
window.showLevelUp(lvl, color)      // полноэкранный оверлей
window.showStarUnlock(stars, color) // анимация звезды

// ДНК
window.DNA_TYPES        // типы: strategist/communicator/creator/analyst
window.DNA_EXTRA        // strengths/quests по типу
window.getDnaColor(type) // цвет типа
window.applyDnaTheme(type)

// Безопасность
window.escHtml(s)       // экранирование HTML (XSS-защита)

// Пользователь
window.getCurrentUser()
window.loadProfile(userId)
window.sb  // Supabase клиент
```

**XP пороги:**
```
Пешка  ★1-5: 0 / 1000 / 3000 / 7000 / 15000
Конь   ★1-5: 25000 / 60000 / 110000 / 180000 / 280000
Слон   ★1-5: 430000 / 630000 / 900000 / 1250000 / 1700000
Ладья  ★1-5: 2300000 / 3100000 / 4000000 / 5000000 / 6000000
Ферзь  ★1-5: 7500000 / 9000000 / 11000000 / 13000000 / 15000000
Король ★1:   25000000
```

---

## EDGE FUNCTION complete-task

**Формула:** `XP = базовые × множитель уровня × множитель стрика`

**Ответ клиенту:**
```javascript
{
  success: true,
  xp_awarded: 1430,
  xp_total: 26430,
  level: 'knight',
  level_stars: 2,
  level_up: false,
  stars_up: true,
  status: 'approved',
  completion_id: '...'
}
```

---

## ПЛАН РАБОТ

### ✅ P0 — ЗАКРЫТ (критические баги)
### ✅ P1 — ЗАКРЫТ (геймификация + ДНК)
### ✅ P2 — ЗАКРЫТ (лидерборд + рефералы + map)
### ✅ ПОЛИРОВКА — ЗАКРЫТА (XSS, дубли, cron, подписка)

### ФАЗА Б — БЕЗОПАСНОСТЬ (СЛЕДУЮЩИЙ ЭТАП)

| # | Задача | Приоритет | Описание |
|---|--------|-----------|----------|
| 1 | Email-подтверждение | HIGH | Код на почту при регистрации |
| 2 | SMS-верификация | HIGH | Код на номер телефона |
| 3 | KYC / Liveness Detection | HIGH | Скан лица, повороты головы, антифрод |
| 4 | 2FA (двухфакторная) | MEDIUM | TOTP или SMS при входе |
| 5 | Rate limiting | MEDIUM | Защита от брутфорса |
| 6 | RLS аудит углублённый | LOW | Проверка всех 138 политик |

### ФАЗА В — АДМИНКА (ПАРАЛЛЕЛЬНО)

| # | Задача |
|---|--------|
| 1 | Панель модерации — проверка заданий, верификаций |
| 2 | Аналитика — графики, метрики, воронки |
| 3 | Управление пользователями — баны, роли |

### ФАЗА Г — P3 ФУНКЦИОНАЛ (ПОСЛЕ)

| # | Задача |
|---|--------|
| 1 | Streak Recovery (заморозка раз в 60 дней) |
| 2 | Автоматические ачивки |
| 3 | Штрафы за невыполнение заданий |
| 4 | Матч-система (свайп) |
| 5 | Эфиры / вебинары |
| 6 | Магазин инструментов |
| 7 | Кошелёк — вывод на крипту/карту |

---

## КАК РАБОТАЕМ

1. Я пишу промпт → ты отправляешь в VS Code Claude
2. VS Code отвечает → скидываешь результат сюда
3. Промпт содержит объяснение что делаем и зачем
4. Один файл = один коммит + git push
5. Подтверждение на изменение — всегда внутри промпта
6. Перед каждым промптом VS Code читает:
   CLAUDE.md, MASTER_RULES.md, ARCHITECTURE.md,
   PROJECT_MAP.md, SESSION_27_02_2026_v4.md

---

## ШАБЛОН СТАРТА НОВОЙ СЕССИИ

```
Ты senior-разработчик проекта TRAFIQO.

Прочитай: CLAUDE.md, MASTER_RULES.md,
ARCHITECTURE.md, PROJECT_MAP.md,
SESSION_27_02_2026_v4.md

Подтверди: по 1 правилу из каждого файла.

Контекст: SESSION_27_02_2026_v4.md
Последний коммит: c643c3e
P0, P1, P2, Полировка — всё закрыто.
Vercel задеплоен.
Cron: 4 задачи активны (jobid 7, 8, 9, 10).
52 экрана реализовано.
Аудит безопасности пройден: 0 XSS, 0 var, 0 console.log.

Следующий этап: Фаза Б — Безопасность
Задача: [КОНКРЕТНАЯ ЗАДАЧА]
```

---

*Документ создан: 27.02.2026*
*Последний коммит: c643c3e*
*P0: ✅ P1: ✅ P2: ✅ Полировка: ✅*
*Следующий этап: Фаза Б — Безопасность*
