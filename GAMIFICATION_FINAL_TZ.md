# TRAFIQO — ГЕЙМИФИКАЦИЯ
## Финальное техническое задание v2.0
**Дата:** 23 февраля 2026 | **Статус:** Согласовано | **Приоритет:** P0

---

# ЧАСТЬ 1: ФИЛОСОФИЯ И СТРАТЕГИЯ

## Почему именно такая система — обоснование

Платформа строится на трёх крючках одновременно:
**Финансовый** (реальные деньги) + **Прогрессивный** (рост и статус) + **Социальный** (сообщество).
Ни Duolingo, ни HeadHunter, ни Telegram не дают все три сразу. Это конкурентное преимущество.

Психологические механизмы заложенные в систему:
- **Переменное вознаграждение** — «Удачный день» и редкие задания создают непредсказуемость
- **Loss Aversion** — потеря streak = потеря множителя заработка (не просто иконки)
- **Endowed Progress** — звезда даётся легко в начале, человек уже вложил, не хочет бросать
- **Социальный статус** — фигура видна всем в ленте, в комментариях, в матчинге
- **Sunk Cost** — каждый следующий уровень требует больше, но ты уже столько вложил

---

# ЧАСТЬ 2: ЭКОНОМИКА XP

## Курс и философия больших чисел
```
1 XP = 0.005 руб. (5 копеек)
200 XP = 1 рубль
1 000 XP = 5 рублей
10 000 XP = 50 рублей
```

Большие числа — намеренное решение. «+1 430 XP» психологически весомее чем «+7 руб.»
Человек ощущает богатство прогресса. Реальная ценность честная, подача — умная.

## Три поля XP в БД (таблица users)
```sql
xp_total    BIGINT DEFAULT 0  -- НИКОГДА не уменьшается → определяет уровень
xp_balance  BIGINT DEFAULT 0  -- доступно для вывода → уменьшается при конвертации  
balance     BIGINT DEFAULT 0  -- рубли в копейках → реальный вывод
```

### Пример: начисление +1 430 XP
```
xp_total:   109 000 → 110 430  ← уровень растёт (защищён)
xp_balance: 8 000   → 9 430    ← доступно для вывода
```

### Пример: вывод 5 000 XP в рубли
```
xp_total:   110 430 → 110 430  ← УРОВЕНЬ НЕ ПАДАЕТ
xp_balance: 9 430   → 4 430    ← уменьшается только это
balance:    12 540  → 37 540   ← +25 руб. (5000 × 0.005)
```

## Начисление XP за действия
```javascript
const XP_REWARDS = {
  // Онбординг
  onboarding_dna:        3000,   // Пройти ДНК-тест
  onboarding_profile:    2000,   // Заполнить профиль
  onboarding_interests:  1000,   // Выбрать интересы
  onboarding_bonus:      2000,   // Бонус за все шаги

  // Контент
  create_post:           800,    // Создать пост
  create_case:           1500,   // Опубликовать кейс
  comment:               200,    // Комментарий 30+ символов
  like:                  50,     // Реакция
  
  // Задания
  task_platform_min:     600,
  task_platform_max:     1400,
  task_ad_min:           1000,
  task_ad_max:           4000,
  task_business_min:     10000,
  task_business_max:     100000,

  // Социальное
  refer_verified:        10000,  // Реферал прошёл верификацию
  social_link:           300,    // Привязать соцсеть
  verification:          5000,   // Пройти верификацию
  
  // Сделки
  deal_complete:         2000,
  deal_review:           500,
};
```

## Формула итоговых XP
```
ИТОГО = Базовые XP × Множитель_уровня × Множитель_streak × Множитель_события
```

### Множитель уровня
| Уровень | Множитель | Что говорить пользователю |
|---------|-----------|--------------------------|
| Пешка   | ×1.0      | Старт                    |
| Конь    | ×1.0      | Учимся, база             |
| Слон    | ×1.3      | +30% к каждому заданию   |
| Ладья   | ×1.6      | +60% к каждому заданию   |
| Ферзь   | ×2.0      | Двойные награды          |
| Король  | ×2.5      | Максимум. Легенда.       |

### Множитель streak
| Дней   | Множитель | Бонус при достижении |
|--------|-----------|---------------------|
| 1–6    | ×1.0      | —                   |
| 7      | ×1.05     | +300 XP + бейдж     |
| 21     | ×1.1      | +500 XP + бейдж     |
| 45     | ×1.15     | +1 000 XP + бейдж   |
| 90     | ×1.2      | +2 000 XP + бейдж   |
| 180    | ×1.7      | +8 000 XP + бейдж   |
| 365    | ×2.5      | +30 000 XP + золотой огонь |

### «Удачный день» — механика случайности
1 раз в 3–7 дней (случайно) пользователь видит утром:
> «Сегодня удачный день. Следующее задание даст ×1.5 XP»

Это переменное вознаграждение — самый сильный психологический крючок.
Платформа контролирует частоту через платформенные настройки.

---

# ЧАСТЬ 3: ТАБЛИЦА ПРОГРЕССИИ

## ЕДИНСТВЕННЫЙ ИСТОЧНИК — только из gamification.js

### Логика звёзд
Каждая фигура = 5 звёзд.
Расстояние между звёздами нарастает — первая даётся легко, пятая требует усилий.
Это Endowed Progress Effect: вложил — не хочешь бросать.

### Пешка (онбординг — первые дни)
Пешка — это ворота. Проходится через приветственный квест.
| Звезда | XP     | Как получить                    |
|--------|--------|---------------------------------|
| ★1     | 0      | Регистрация + ДНК-тест          |
| ★2     | 3 000  | Заполнить профиль               |
| ★3     | 6 000  | Выбрать интересы                |
| ★4     | 12 000 | Первое задание выполнено        |
| ★5     | 21 000 | Верификация → переход на Коня   |

Итого квест: ~21 000 XP (~105 руб. за 10 минут)
После Пешки ★5 — автоматический переход на Конь ★1 с анимацией.

### Конь (1–6 месяцев) — самый важный уровень
Большинство пользователей живут здесь. Самые интересные пасхалки.
| Звезда | XP минимум | XP до след. | Время (PRO) |
|--------|------------|-------------|-------------|
| ★1     | 25 000     | 35 000      | 7–10 дней   |
| ★2     | 60 000     | 50 000      | 3–4 недели  |
| ★3     | 110 000    | 70 000      | 6–8 недель  |
| ★4     | 180 000    | 100 000     | 3–4 месяца  |
| ★5     | 280 000    | 150 000     | 5–6 месяцев |

### Слон (7–18 месяцев) — элита
| Звезда | XP минимум | XP до след. |
|--------|------------|-------------|
| ★1     | 430 000    | 200 000     |
| ★2     | 630 000    | 270 000     |
| ★3     | 900 000    | 350 000     |
| ★4     | 1 250 000  | 450 000     |
| ★5     | 1 700 000  | 600 000     |

### Ладья (19–36 месяцев) — редкость
| ★1 | 2 300 000 | ★5 | 6 800 000 |

### Ферзь (36+ месяцев) — легенда
| ★1 | 8 600 000 | ★5 | 21 600 000 |

### Король (60+ месяцев) — единственный в своём роде
| ★1 | 26 600 000 | xpNext: null |
Король — это звание которое знают все на платформе.
Особый серийный номер карточки: KING-XXXX.

---

# ЧАСТЬ 4: ДНК-КАРТОЧКА — ПОЛНАЯ СПЕЦИФИКАЦИЯ

## Концепция дизайна
Карточка = личный паспорт в мире TRAFIQO.
Не игровой ачивмент — премиальный документ который хочется показать.
Референс: Revolut Metal Card + Magic: The Gathering + Pokémon карта.
Тёмный металлик, голографический эффект, персональный серийный номер.

## Дизайн карточки — структура

```
┌─────────────────────────────────────────────────────────┐
│  ░ TRAFIQO ░░░░░░░░░░░░░░░░░░░░░░░░░░░ IDENTITY PASS  │
│                                                           │
│  ┌──────────────────────────────────────────────────┐   │
│  │                                                    │   │
│  │   [SVG Фигура 72px]     ДНК: [цветной badge]     │   │
│  │   пульсирует в цвете     КОММУНИКАТОР             │   │
│  │   ДНК-типа               ████████████░░           │   │
│  │                                                    │   │
│  │   КОНЬ  ★★★☆☆  67%                               │   │
│  │   Алексей Петров                                   │   │
│  │                                                    │   │
│  │   XP: 157 000 / 180 000                           │   │
│  │   ████████████░░░░  до ★★★★                       │   │
│  │                                                    │   │
│  │   Множитель заработка:  ×1.0                      │   │
│  │   На следующем уровне:  ×1.3  (+30%)              │   │
│  │                                                    │   │
│  │   ── ПУТЬ ──────────────────────────────────────  │   │
│  │   ♟ ──── ♞ ──── [♝] ──── ♜ ──── ♛ ──── ♚        │   │
│  │  Пешка  Конь   Слон   Ладья  Ферзь  Король        │   │
│  │                 ↑ ТЫ ЗДЕСЬ                        │   │
│  │                                                    │   │
│  │   MEMBER SINCE Feb 2026        #TRF-000001        │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

## CSS-стиль карточки

```css
/* Базовый стиль */
background: linear-gradient(135deg, #0a0a14 0%, #12122a 50%, #0a0a14 100%);
border: 1px solid rgba(255,255,255,0.08);
border-radius: 20px;
box-shadow:
  0 0 0 1px rgba(255,255,255,0.05),
  0 20px 60px rgba(0,0,0,0.8),
  0 0 80px rgba(139,92,246,0.15); /* фиолетовый glow */

/* Голографический shimmer */
background-image:
  linear-gradient(135deg, #0a0a14 0%, #12122a 50%, #0a0a14 100%),
  linear-gradient(45deg,
    transparent 30%,
    rgba(255,255,255,0.03) 50%,
    transparent 70%
  );
animation: dnrShine 8s infinite;

/* Цвет акцентов = цвет ДНК пользователя */
/* Стратег: #3b82f6 | Коммуникатор: #22c55e */
/* Креатор: #f59e0b | Аналитик: #a78bfa */
```

## Три таба под карточкой

### Таб 1: «МОЙ ПУТЬ» (открыт по умолчанию)
```
Визуальная дорожная карта: Пешка → Конь → [Слон] → Ладья → Ферзь → Король

Для каждого уровня показывать:
- Иконка фигуры (активная — в цвете ДНК, будущие — серые)
- Что открывается (конкретно!)
- При текущем уровне — прогресс и прогноз

Прогноз: «При текущем темпе — ★★★★ через 18 дней»
Расчёт: (XP до след. звезды) / (средние XP в день за 7 дней)

Что открывается на каждом уровне — текст:
knight_1: «Лента, задания, реферальная система»
knight_3: «Гарант-сделки, магазин»
knight_5: «Продажа товаров, VIP-заказы»
bishop_1: «Менторство, ×1.3 к заработку»
rook_1:   «Премиум-задания, ×1.6 к заработку»
queen_1:  «Создание курсов, ×2.0 к заработку»
king_1:   «Легенда платформы, ×2.5, уникальный статус»
```

### Таб 2: «МОИ ЗАРАБОТКИ»
```
График XP за 7 дней (sparkline — тонкая линия в цвете ДНК)
Сравнение с прошлой неделей: «+23% к прошлой неделе»

Топ-источники этой недели:
  Задания Импульс:   8 400 XP  ████████░░
  Рефералы:          3 200 XP  ███░░░░░░░
  Контент:           1 600 XP  ██░░░░░░░░

Баланс доступный к выводу: 4 430 XP = 22.15 руб.
[Конвертировать в рубли]
```

### Таб 3: «ДОСТИЖЕНИЯ»
```
Полученные бейджи с датами (яркие иконки SVG)
Следующие 3 достижения с прогрессом:
  «Неделя» — streak 7 дней — прогресс 4/7
  «Первая сделка» — создать гарант-сделку
  «Упорный» — Конь ★5

Особые бейджи:
  «Первопроходец» — регистрация в первые 1000 пользователей
  «Железная воля» — streak 150 дней
  «Легенда» — уровень Король
```

---

# ЧАСТЬ 5: АНИМАЦИИ — ПОЛНАЯ СПЕЦИФИКАЦИЯ

## 5.1 Анимация ДНК-рулетки (доработка существующей)

Текущие 6 фаз сохраняются. Доработки:

**Фаза 4 (победитель всплывает):**
Добавить «след» — 8 частиц разлетаются в цвете ДНК при всплытии.
```css
@keyframes dnrParticleTrail {
  0%   { transform: translate(0,0) scale(1); opacity:0.8; }
  100% { transform: translate(var(--dx), var(--dy)) scale(0); opacity:0; }
}
/* duration: 600ms, 8 частиц с разными --dx/--dy */
```

**Фаза 6 (карточка появляется):**
Заменить текущий fade на «выдвижение из волны»:
```css
@keyframes dnrCardEmerge {
  0%   { transform: scale(0.3) translateY(60px); opacity:0; filter:blur(20px); }
  60%  { transform: scale(1.04) translateY(-8px); opacity:1; filter:blur(0); }
  80%  { transform: scale(0.98) translateY(3px); }
  100% { transform: scale(1) translateY(0); }
}
/* duration: 800ms, easing: cubic-bezier(0.16, 1, 0.3, 1) */
```

## 5.2 Анимация прогресс-бара XP (при открытии карточки)

```css
@keyframes xpBarFill {
  from { width: 0%; }
  to   { width: var(--xp-percent); }
}
/* duration: 1200ms, delay: 300ms после появления карточки */
/* easing: cubic-bezier(0.4, 0, 0.2, 1) */

/* Цвет по ДНК */
.xp-bar--strategist  { background: linear-gradient(90deg, #3b82f6, #93c5fd); }
.xp-bar--communicator{ background: linear-gradient(90deg, #22c55e, #86efac); }
.xp-bar--creator     { background: linear-gradient(90deg, #f59e0b, #fcd34d); }
.xp-bar--analyst     { background: linear-gradient(90deg, #a78bfa, #c4b5fd); }
```

## 5.3 Анимация зажигания звезды (новая)

Когда накоплено XP для новой звезды — в момент следующего входа в профиль:

```
1. Звезда ☆ → мерцание (200ms, opacity 0.5↔1, 3 раза)
2. Вспышка белого halo вокруг звезды (opacity 0→0.8→0, 300ms)
3. Звезда ★ с анимацией:
   scale 0, rotate -30deg → scale 1.4, rotate 10deg → scale 0.9 → scale 1
   duration: 500ms, easing: cubic-bezier(0.34, 1.56, 0.64, 1)
4. 3 мини-частицы разлетаются из центра звезды (цвет ДНК)
5. Toast: «Новая звезда! Конь ★★★★» (2 сек)
6. Haptic feedback (Telegram WebApp.HapticFeedback.notificationOccurred('success'))
```

```css
@keyframes starUnlock {
  0%   { transform: scale(0) rotate(-30deg); opacity:0; }
  50%  { transform: scale(1.4) rotate(10deg); opacity:1; }
  70%  { transform: scale(0.9) rotate(-5deg); }
  100% { transform: scale(1) rotate(0deg); opacity:1; }
}
```

## 5.4 Анимация Level-Up (ГЛАВНОЕ СОБЫТИЕ — переход между фигурами)

Полноэкранный оверлей. Нельзя закрыть — только «Продолжить».

```
ms 0:    Тёмный оверлей opacity 0→0.95 (400ms)
ms 400:  Старая SVG-фигура в центре экрана, scale 1.0
ms 600:  Старая фигура pulse: scale 1→1.2→1→1.2→1 (600ms)
ms 1200: Старая фигура dissolve: разлетается на 12 частиц в стороны (400ms)
ms 1400: Пустота 200ms — это намеренно. Напряжение.
ms 1600: Новая фигура материализуется: scale 0, blur 20px → scale 1, blur 0 (600ms)
ms 1800: Взрывная волна в цвете ДНК (переиспользовать dnrWave из dna.css!)
ms 2000: Конфетти 40 частиц в цвете ДНК, сыпется сверху (1500ms)
ms 2200: Текст появляется снизу вверх (stagger 100ms между строками):
          Строка 1: «ТЫ СТАЛ СЛОНОМ» (крупно, цвет ДНК)
          Строка 2: «Множитель заработка: ×1.3»
          Строка 3: «+30% к каждому заданию навсегда»
          Строка 4: [список что открылось, до 3 пунктов]
ms 3500: Кнопка «Продолжить» с bounce-появлением
```

**Переиспользовать:** `dnrWave`, `dnrRipple`, `dnrFloat` из `css/dna.css`
**Новые:** `levelUpOverlay`, `figureDissolve`, `figureMaterialize`, `confettiFall`

## 5.5 Toast «+XP» при начислении

```css
/* Позиция: под header, по центру */
/* duration всей анимации: 2000ms */

@keyframes xpToastIn {
  from { transform: translateY(-20px); opacity:0; }
  to   { transform: translateY(0); opacity:1; }
}
@keyframes xpToastOut {
  from { transform: translateY(0); opacity:1; }
  to   { transform: translateY(-30px); opacity:0; }
}
```

Правила:
- До 1 000 XP → зелёный (#22c55e), размер шрифта 14px
- 1 000–5 000 XP → золотой (#fbbf24), размер 16px
- 5 000+ XP → пульсирующий золотой, размер 18px + scale animation
- Level-up → особый toast → сразу запускает анимацию 5.4

## 5.6 Streak fire — визуальный рост

Огонь меняется визуально по milestone:
- 1–6 дней: маленький огонёк, серый
- 7–20 дней: оранжевый, небольшой
- 21–44 дней: оранжево-красный, средний
- 45–89 дней: яркий красный, пульсирует
- 90–179 дней: красно-золотой, активная анимация
- 180–364 дней: золотой, с частицами
- 365+ дней: радужный/голографический, уникальный

Это визуальный сигнал статуса. Люди не захотят терять красивый огонь.

---

# ЧАСТЬ 6: РЕЙТИНГ-СИСТЕМА

## Четыре параллельных рейтинга

### 1. Рейтинг недели (главный)
- Сбрасывается каждое воскресенье 23:59
- Показывает топ-100 по XP за текущую неделю
- Каждый видит своё место + соседей ±5
- **Ключевой принцип:** новичок тоже может попасть в топ если старается эту неделю
- Победитель недели — специальный бейдж «Чемпион недели» на 7 дней

### 2. Рейтинг по уровню
- Кони соревнуются с Конями
- Новичок видит себя в реальной борьбе, не теряется среди Слонов
- Переход на новый уровень = переход в новую лигу (объявление!)

### 3. Рейтинг по ДНК-типу
- Стратеги vs Стратеги и т.д.
- Создаёт племенную идентичность
- «Ты 3-й среди Коммуникаторов этой недели»

### 4. Рейтинг рефералов
- Кто привёл больше активных пользователей (прошедших верификацию)
- Отдельный экран с «деревом» влияния
- Топ-5 рефереров месяца — публичное признание

## Что показывать публично
На экране рейтинга показывать:
- Топ-1 этой недели заработал: **4 200 руб.** — это мощный социальный сигнал
- Топ-10 с аватарами, уровнями, XP за неделю
- Твоё место + ближайшие соперники

---

# ЧАСТЬ 7: ПАСХАЛКИ — ЛИЧНЫЕ СОБЫТИЯ

На каждой звезде — автоматическое персональное сообщение в уведомлениях.
Это скринят и постят. Это вирусность.

```
Конь ★1: «Первый шаг сделан. 25 000 XP — именно столько нейронных связей
           формируется при освоении нового навыка. Ты начал меняться.»

Конь ★3: «110 000 шагов. Именно столько нужно чтобы пройти из Москвы до Твери.
           Ты в середине пути. Большинство остановятся здесь. Не ты.»

Конь ★5: «280 000 XP. Ты в топ-15% пользователей платформы.
           Слон ждёт тебя. Там множитель ×1.3 к каждому заданию.»

Слон ★1: «Добро пожаловать в элиту. Только 8% пользователей доходят до Слона.
           Ты заработал уважение сообщества. И +30% к каждому заданию.»
           + уведомление рефералам: «Твой друг [имя] стал Слоном»

Ладья ★1: «Ладья. Это серьёзно. Меньше 2% пользователей здесь.
            Твой уникальный серийный номер: ROOK-[XXXX]»

Ферзь ★1: «Ферзь. Легенда платформы. 0.3% пользователей.
            Ты можешь создавать курсы. Ты влияешь на платформу.»

Король ★1: «КОРОЛЬ. Первый в истории платформы.
             Серийный номер: KING-0001. Навсегда.»
```

---

# ЧАСТЬ 8: МАТЧИНГ И ГЕЙМИФИКАЦИЯ

## Связь уровней с матч-системой

Уровень влияет на матчинг напрямую:
- Базовый поиск: ±1 уровень от тебя
- Иногда появляется карточка выше уровнем: «Редкий матч — этот человек выше тебя»
- Слон видя Коня понимает свой статус — это подкрепляет ценность роста

## Совместимость ДНК → конверсия в сделки
```
Стратег + Коммуникатор: 85% — лучшая пара (планирование + продвижение)
Стратег + Аналитик:     80% — сильная пара
Коммуникатор + Креатор: 78% — творческий дуэт
Любые + Любые:          60% — базовая совместимость
```

Высокая совместимость → рекомендация создать гарант-сделку.
Это конвертирует матчинг в реальный доход платформы (20% комиссия).

---

# ЧАСТЬ 9: ОБУЧЕНИЕ ЧЕРЕЗ ЗАДАНИЯ

## Скрытые навыки
На экране задания — плашка внизу:
> «Это задание развивает навык: Копирайтинг. Прогресс: 8/20»

Когда 20/20 — предложение:
> «Ты выполнил 20 заданий на Копирайтинг. Пройди сертификацию в Академии
>  и добавь это в карточку эксперта»

Цикл: Задание → Навык → Сертификат → Карточка эксперта → Заказы → Доход

## Треки навыков
```
Копирайтинг:   задания с текстом (комментарии, обзоры, посты)
SMM:           репосты, сторис, вовлечённость
Аналитика:     оценки, отчёты, данные
Продажи:       рефералы, рекомендации, презентации
Дизайн:        визуальные задания (когда появятся)
```

---

# ЧАСТЬ 10: ЭКОНОМИКА ЗАДАНИЙ — БИЗНЕС-ЛОГИКА

## Расщепление денег рекламодателя

```
Рекламодатель платит: 5 000 руб.
├── Платформа забирает: 40% = 2 000 руб.
│   (серверы, команда, развитие, прибыль)
└── Исполнители получают: 60% = 3 000 руб.
    Распределяется между выполнившими задание
```

При 100 исполнителях: каждый получает 30 руб. = 6 000 XP.
Для пользователя: «+6 000 XP» — звучит щедро.
Для платформы: маржа 40% — здоровый бизнес.

## Пакеты для рекламодателей
| Пакет | Цена | Исполнителей | Платформе | Людям |
|-------|------|-------------|-----------|-------|
| Старт | 1 000 | 50 | 400 руб. | 600 руб. (12 руб./чел) |
| Базовый | 3 000 | 150 | 1 200 | 1 800 руб. (12 руб./чел) |
| Продвинутый | 7 000 | 400 | 2 800 | 4 200 руб. (10.5 руб./чел) |
| Максимальный | 15 000 | 1 000 | 6 000 | 9 000 руб. (9 руб./чел) |

---

# ЧАСТЬ 11: ФАЙЛЫ ДЛЯ РЕАЛИЗАЦИИ

## Создать новые

| Файл | Строк | Содержимое |
|------|-------|-----------|
| `js/utils/gamification.js` | ~180 | XP_TABLE, функции, экспорты |
| `js/utils/xp-animations.js` | ~150 | showXpToast, showLevelUp, showStarUnlock |
| `css/gamification.css` | ~200 | Все keyframes геймификации |

## Изменить существующие

| Файл | Что изменить | Приоритет |
|------|-------------|-----------|
| `js/feed-data.js` | `_profile.xp` → `_profile.xp_total` (3 места) | КРИТИЧНО |
| `js/screens/profile.js` | Добавить king, удалить локальные пороги | КРИТИЧНО |
| `js/admin-pages4.js` | Удалить локальные пороги → gamification.js | ВАЖНО |
| `js/admin-data.js` | Удалить локальные пороги → gamification.js | ВАЖНО |
| `js/dna-test.js` | СНАЧАЛА РАЗБИТЬ (412 строк) | ВАЖНО |
| `templates/dna-result.html` | Новый дизайн карточки + 3 таба | ВАЖНО |
| `css/dna.css` | dnrCardEmerge + starUnlock keyframes | ВАЖНО |

## Разбивка dna-test.js (412 строк → 2 файла)
```
js/dna-test.js     ~200 строк — только логика теста (вопросы, подсчёт)
js/dna-result.js   ~200 строк — показ карточки, табы, анимации
```

## Порядок коммитов (один файл = один коммит)

```
Коммит 1:  fix: feed-data.js — xp → xp_total (3 строки, критичный баг)
Коммит 2:  fix: profile.js — добавить king уровень
Коммит 3:  feat: gamification.js — единая таблица и функции
Коммит 4:  feat: xp-animations.js — toast, levelUp, starUnlock
Коммит 5:  feat: gamification.css — все keyframes
Коммит 6:  refact: dna-test.js → dna-test.js + dna-result.js
Коммит 7:  feat: dna-result.html — новая карточка + 3 таба
Коммит 8:  feat: dna.css — dnrCardEmerge + обновления
Коммит 9:  fix: profile.js, admin-*.js — убрать дубли порогов
Коммит 10: feat: gamification-rating экран
```

---

# ЧАСТЬ 12: ТАБЛИЦЫ БД — ЧТО ИЗМЕНИТЬ

## Таблица users — поля геймификации
```sql
xp_total      BIGINT DEFAULT 0          -- никогда не уменьшается
xp_balance    BIGINT DEFAULT 0          -- доступно для вывода
balance       BIGINT DEFAULT 0          -- рубли (копейки)
level         TEXT DEFAULT 'pawn'        -- pawn/knight/bishop/rook/queen/king
level_stars   SMALLINT DEFAULT 0         -- 0-5
streak_days   INT DEFAULT 0             -- ЕДИНСТВЕННЫЙ ИСТОЧНИК STREAK
streak_last_date DATE                   -- дата последней активности
```

## Таблица xp_rates — курс конвертации
```sql
id             UUID PRIMARY KEY
rate           DECIMAL(10,6) DEFAULT 0.005000  -- 1 XP = 0.005 руб.
effective_from TIMESTAMPTZ DEFAULT now()
note           TEXT
```

## Таблица achievements — бейджи
```sql
id          UUID PRIMARY KEY
user_id     UUID REFERENCES users(id)
badge_type  TEXT -- 'streak_7', 'knight_5', 'first_deal', 'week_champion'
badge_name  TEXT
badge_icon  TEXT -- SVG строка
xp_bonus    BIGINT DEFAULT 0
earned_at   TIMESTAMPTZ DEFAULT now()
UNIQUE(user_id, badge_type)
```

## Таблица platform_settings — настройки геймификации
```sql
-- Ключи которые нужны:
'lucky_day_probability'   -- вероятность «Удачного дня» (default: 0.15)
'xp_rate'                 -- курс (default: 0.005)
'streak_recovery_days'    -- раз в сколько дней можно восстановить streak
```

## Edge Functions — что нужно

| Функция | Статус | Что делает |
|---------|--------|-----------|
| `complete-task` | Есть | Начислить XP + проверить level-up |
| `convert-xp` | Нужно создать | xp_balance → balance |
| `update-streaks` | Нужно создать | CRON ежедневно 00:05 |

### convert-xp — логика
```typescript
1. Проверить auth.uid()
2. Получить текущий курс из xp_rates (последний по effective_from)
3. Получить xp_balance пользователя
4. Если xp_balance < 200 → ошибка «Минимум 200 XP (1 руб.)»
5. Рассчитать: rubles_kopecks = xp_balance * rate * 100
6. UPDATE users: balance += rubles_kopecks, xp_balance = 0
7. INSERT transactions: type='xp_conversion', xp_amount=-xp_balance, amount=+rubles_kopecks
8. Вернуть: { converted_xp, rubles_added, new_balance }
```

### complete-task — дополнение (проверка level-up)
```typescript
// После начисления XP добавить:
const oldLevel = user.level;
const oldStars = user.level_stars;
const newLevelData = Gamification.getUserLevel(user.xp_total + earnedXP);

if (newLevelData.level !== oldLevel || newLevelData.stars !== oldStars) {
  await updateUserLevel(userId, newLevelData);
  await createLevelUpNotification(userId, oldLevel, newLevelData);
  return { ...result, levelUp: { old: {oldLevel, oldStars}, new: newLevelData } };
}
```

---

# ЧАСТЬ 13: GAMIFICATION.JS — ПОЛНОЕ API

```javascript
// ═══════════════════════════════════════════════════
// GAMIFICATION.JS
// Единый источник правды для всей геймификации
// ═══════════════════════════════════════════════════

window.Gamification = {
  XP_TABLE,        // таблица прогрессии (полная, 26 строк)
  XP_REWARDS,      // награды за действия
  LEVEL_UNLOCKS,   // что открывается на уровне
  DNA_COLORS,      // цвета ДНК (из dna.js)
  
  getUserLevel(xpTotal),
  // → { level:'knight', stars:3, label:'Конь', index:8 }
  
  getLevelProgress(xpTotal),
  // → { percent:67, current:47000, needed:70000, nextStars:4 }

  getMultiplier(level),
  // → 1.0 / 1.3 / 1.6 / 2.0 / 2.5
  
  getChessIcon(level, dnaColor, size),
  // → SVG-строка (все 6 фигур включая king)
  
  getLevelUnlocks(level, stars),
  // → ['Менторство', 'Бизнес-задания']
  
  calculateEarnedXP(baseXP, level, streakDays),
  // → итоговые XP с множителями
  
  getDaysToNextStar(xpTotal, dailyAvgXP),
  // → 18 (дней) или null если нет данных
  
  getStreakMultiplier(streakDays),
  // → 1.0 / 1.05 / 1.1 и т.д.
  
  getPaskhalkаText(level, stars),
  // → строка персонального сообщения
};
```

---

# ИТОГ: ПОЧЕМУ ЭТО БУДЕТ РАБОТАТЬ

**1. Реальные деньги** — не баллы, не бонусы. Рубли на вывод. Это доверие.

**2. Видимый прогресс каждый день** — звезда каждые 1-2 недели для Коня.
Маленькие победы держат лучше чем редкие большие.

**3. Статус виден всем** — фигура в ленте, в комментариях, в матчинге.
Люди хотят выглядеть лучше. Это вирусность.

**4. Потеря больнее приобретения** — streak = множитель заработка.
Потерять streak = потерять деньги. Люди будут заходить каждый день.

**5. Обучение через заработок** — человек думает что зарабатывает.
На самом деле ещё и учится. Через 3 месяца он эксперт.

**6. Замкнутый маховик** — рекламодатель → задания → XP → уровень →
возможности → больше заданий → больше рекламодателей.

Эта система не просто геймификация. Это экономический двигатель платформы.

---

*TRAFIQO Gamification TZ v2.0 FINAL | 23 февраля 2026*
*Следующий шаг: согласование → реализация по порядку коммитов*
